<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmacia Centrale - App</title>
  <style>
    /* Design System */
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

    :root {
      /* Soft UI Palette */
      --color-background: #F2F6F9;
      --color-surface: #FFFFFF;
      --color-text: #1A202C;
      --color-text-secondary: #718096;

      /* Brand Colors & Gradients */
      --color-primary: #2D9CDB;
      --gradient-primary: linear-gradient(135deg, #32B8C6 0%, #2DA6B2 100%);
      --gradient-accent: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
      --gradient-soft: linear-gradient(180deg, #FFFFFF 0%, #F2F6F9 100%);

      --color-teal-500: #32B8C6;
      --color-teal-600: #2DA6B2;

      --color-error: #FF6B6B;
      --color-success: #51CF66;

      /* Spacing & Layout */
      --space-4: 4px;
      --space-8: 8px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;

      --radius-sm: 12px;
      --radius-md: 20px;
      --radius-lg: 30px;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 12px 24px -10px rgba(50, 184, 198, 0.15);
      --shadow-lg: 0 20px 40px -15px rgba(0, 0, 0, 0.1);
      --shadow-float: 0 10px 30px rgba(50, 184, 198, 0.25);

      /* Typography */
      --font-family-base: 'Outfit', sans-serif;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 17px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-size-3xl: 32px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-bold: 700;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font-family-base);
      font-size: var(--font-size-base);
      color: var(--color-text);
      background-color: var(--color-background);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 100px;
      background-image:
        radial-gradient(circle at 0% 0%, rgba(50, 184, 198, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(255, 154, 158, 0.05) 0%, transparent 50%);
      background-attachment: fixed;
      min-height: 100vh;
    }

    .app-header {
      background: transparent;
      color: var(--color-text);
      padding: var(--space-24) var(--space-20) var(--space-12);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: none;
    }

    .header-content {
      text-align: left;
    }

    .header-account-btn {
      background: var(--color-surface);
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      color: var(--color-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .header-account-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
      color: var(--color-teal-600);
    }

    .app-header h1 {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-4);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .app-header p {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-medium);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .tab-content {
      display: none;
      padding: var(--space-16);
      max-width: 800px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    .bottom-nav {
      position: fixed;
      bottom: var(--space-24);
      left: var(--space-20);
      right: var(--space-20);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-top: none;
      border-radius: var(--radius-lg);
      display: flex;
      justify-content: space-around;
      padding: var(--space-12) var(--space-8);
      box-shadow: var(--shadow-float);
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--space-8);
      color: var(--color-text-secondary);
      cursor: pointer;
      border: none;
      background: none;
      font-size: var(--font-size-sm);
      transition: color 0.2s;
    }

    .nav-item:hover {
      color: var(--color-primary);
    }

    .nav-item.active {
      color: var(--color-primary);
      font-weight: var(--font-weight-medium);
    }

    .nav-icon {
      font-size: var(--font-size-2xl);
      margin-bottom: var(--space-4);
    }

    .card {
      background: var(--color-surface);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      margin-bottom: var(--space-24);
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .card h2 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-12);
      color: var(--color-text);
    }

    .card h3 {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-8);
      color: var(--color-text);
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-12);
      margin-bottom: var(--space-16);
    }

    .quick-action-btn {
      background: var(--color-surface);
      border: none;
      border-radius: var(--radius-md);
      padding: var(--space-20);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--color-text);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .quick-action-btn:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      color: var(--color-teal-600);
    }

    .quick-action-btn:active {
      transform: scale(0.98);
    }

    .quick-action-btn .icon {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-8);
    }

    .form-group {
      margin-bottom: var(--space-16);
    }

    .form-label {
      display: block;
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-8);
      color: var(--color-text);
    }

    .form-control {
      width: 100%;
      padding: var(--space-16);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      background: var(--color-background);
      color: var(--color-text);
      transition: all 0.3s;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .form-control:focus {
      outline: none;
      background: var(--color-surface);
      box-shadow: 0 0 0 3px rgba(50, 184, 198, 0.2);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 80px;
      font-family: var(--font-family-base);
    }

    .btn {
      display: inline-block;
      padding: var(--space-16) var(--space-32);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      box-shadow: var(--shadow-float);
      transform: translateY(-2px);
      filter: brightness(1.05);
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: var(--color-secondary-hover);
    }

    .btn-full {
      width: 100%;
    }

    .btn-danger {
      background: var(--color-error);
      color: white;
      padding: var(--space-8) var(--space-12);
      font-size: var(--font-size-sm);
    }

    .alert {
      padding: var(--space-16);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-16);
    }

    .alert-success {
      background: var(--color-bg-3);
      color: var(--color-success);
      border: 1px solid rgba(var(--color-teal-500-rgb), 0.3);
    }

    .alert-info {
      background: var(--color-bg-1);
      color: var(--color-text);
      border: 1px solid var(--color-card-border);
    }

    .appointment-item {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      margin-bottom: var(--space-12);
    }

    .appointment-item h4 {
      font-size: var(--font-size-lg);
      margin-bottom: var(--space-8);
      color: var(--color-text);
    }

    .appointment-item p {
      margin: var(--space-4) 0;
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .appointment-actions {
      margin-top: var(--space-12);
      display: flex;
      gap: var(--space-8);
    }

    .medicine-result {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-20);
      margin-top: var(--space-16);
    }

    .medicine-result h3 {
      color: var(--color-primary);
      font-size: var(--font-size-2xl);
      margin-bottom: var(--space-16);
    }

    .medicine-info-item {
      margin-bottom: var(--space-16);
    }

    .medicine-info-item strong {
      display: block;
      color: var(--color-text);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-4);
    }

    .medicine-info-item p {
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    .search-tabs {
      display: flex;
      gap: var(--space-8);
      margin-bottom: var(--space-16);
    }

    .search-tab {
      flex: 1;
      padding: var(--space-12);
      background: var(--color-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      cursor: pointer;
      text-align: center;
      font-weight: var(--font-weight-medium);
      transition: all 0.2s;
    }

    .search-tab.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .search-section {
      display: none;
    }

    .search-section.active {
      display: block;
    }

    .chat-container {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      height: 500px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-16);
      display: flex;
      flex-direction: column;
      gap: var(--space-12);
    }

    .message {
      padding: var(--space-12) var(--space-16);
      border-radius: var(--radius-base);
      max-width: 80%;
      word-wrap: break-word;
    }

    .message-user {
      background: var(--color-primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message-ai {
      background: var(--color-bg-1);
      color: var(--color-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .chat-input-container {
      display: flex;
      gap: var(--space-8);
      padding: var(--space-16);
      border-top: 1px solid var(--color-border);
    }

    .chat-input {
      flex: 1;
    }

    .info-grid {
      display: grid;
      gap: var(--space-12);
    }

    .info-item {
      display: flex;
      align-items: start;
      gap: var(--space-12);
    }

    .info-icon {
      font-size: var(--font-size-xl);
      color: var(--color-primary);
      min-width: 24px;
    }

    .info-content p {
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    .featured-medicines {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: var(--space-12);
    }

    .medicine-card {
      background: var(--color-surface);
      border: none;
      border-radius: var(--radius-md);
      padding: var(--space-16);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--shadow-sm);
    }

    .medicine-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }

    .medicine-card .icon {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-8);
    }

    .medicine-card .name {
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      font-size: var(--font-size-sm);
    }

    .file-upload {
      border: 2px dashed var(--color-teal-300);
      border-radius: var(--radius-lg);
      padding: var(--space-32);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(50, 184, 198, 0.05);
    }

    .file-upload:hover {
      border-color: var(--color-primary);
      background: var(--color-bg-1);
    }

    .file-upload input {
      display: none;
    }

    .confidence-badge {
      display: inline-block;
      padding: var(--space-4) var(--space-12);
      background: var(--color-bg-3);
      color: var(--color-success);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-12);
    }

    @media (max-width: 768px) {
      .quick-actions {
        grid-template-columns: 1fr;
      }

      .featured-medicines {
        grid-template-columns: repeat(2, 1fr);
      }

      .chat-container {
        height: 400px;
      }

      .message {
        max-width: 90%;
      }
    }

    .logo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: var(--space-16);
      border: none;
      box-shadow: var(--shadow-float);
    }

    .icon-sm {
      width: 18px;
      height: 18px;
      vertical-align: text-bottom;
      margin-right: 6px;
      stroke-width: 2.5px;
    }

    /* Floating Action Button */
    .fab-btn {
      position: fixed;
      bottom: 140px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--gradient-primary);
      color: white;
      border: none;
      box-shadow: var(--shadow-float);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 90;
      transition: all 0.3s;
    }

    .fab-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    .hidden {
      display: none !important;
    }
  </style>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="js/auth.js"></script>
  <script src="js/seedData.js"></script>
</head>

<body>
  <div class="app-header">
    <div class="header-content">
      <h1>Farmacia Picco</h1>
      <p id="user-greeting">OFFICINA DELLA SALUTE</p>
    </div>
    <button class="header-account-btn" onclick="switchTab('account')">
      <i data-lucide="user" style="width: 24px; height: 24px;"></i>
    </button>
  </div>

  <!-- Home Tab -->
  <div id="home-tab" class="tab-content active">
    <div class="quick-actions">
      <button class="quick-action-btn" onclick="switchTab('appointments')">
        <div class="icon"><i data-lucide="calendar"></i></div>
        <div>Prenota Appuntamento</div>
      </button>
      <button class="quick-action-btn" onclick="switchTab('ai')">
        <div class="icon"><i data-lucide="bot"></i></div>
        <div>Chiedi all'AI</div>
      </button>
      <button class="quick-action-btn" onclick="switchTab('medicine')">
        <div class="icon"><i data-lucide="pill"></i></div>
        <div>Cerca Farmaco</div>
      </button>
    </div>

    <div class="card">
      <h2>Farmaci Popolari</h2>
      <div class="featured-medicines">
        <div class="medicine-card" onclick="searchMedicineByName('Aspirina')">
          <div class="icon"><i data-lucide="pill"></i></div>
          <div class="name">Aspirina</div>
        </div>
        <div class="medicine-card" onclick="searchMedicineByName('Tachipirina')">
          <div class="icon"><i data-lucide="pill"></i></div>
          <div class="name">Tachipirina</div>
        </div>
        <div class="medicine-card" onclick="searchMedicineByName('Ibuprofene')">
          <div class="icon"><i data-lucide="pill"></i></div>
          <div class="name">Ibuprofene</div>
        </div>
        <div class="medicine-card" onclick="searchMedicineByName('Omeprazolo')">
          <div class="icon"><i data-lucide="pill"></i></div>
          <div class="name">Omeprazolo</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Informazioni Farmacia</h2>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-icon"><i data-lucide="map-pin"></i></div>
          <div class="info-content">
            <strong>Indirizzo</strong>
            <p>Via Roma, 123 - 13100 Vercelli</p>
          </div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i data-lucide="phone"></i></div>
          <div class="info-content">
            <strong>Telefono</strong>
            <p>+39 0161 234567</p>
          </div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i data-lucide="mail"></i></div>
          <div class="info-content">
            <strong>Email</strong>
            <p>info@farmaciacentrale.it</p>
          </div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i data-lucide="clock"></i></div>
          <div class="info-content">
            <strong>Orari</strong>
            <p>Lun-Ven: 08:30-20:00<br>Sab: 08:30-19:00<br>Dom: 09:00-13:00</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Appointments Tab -->
  <div id="appointments-tab" class="tab-content">

    <!-- Appointments List View -->
    <div id="appointments-view">
      <div class="card">
        <h2>I Miei Appuntamenti</h2>
        <div id="appointments-list"></div>
      </div>

      <button class="fab-btn" onclick="showBookingForm()">
        <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
      </button>
    </div>

    <!-- Booking Form View -->
    <div id="booking-view" class="hidden">
      <button class="btn btn-secondary" onclick="hideBookingForm()" style="margin-bottom: var(--space-16);">
        <i data-lucide="arrow-left" class="icon-sm"></i> Torna alla lista
      </button>

      <div class="card">
        <h2>Prenota un Appuntamento</h2>
        <form id="appointment-form">
          <div class="form-group">
            <label class="form-label">Data *</label>
            <input type="date" id="apt-date" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Orario *</label>
            <select id="apt-time" class="form-control" required>
              <option value="">Seleziona un orario</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo di Servizio *</label>
            <select id="apt-service" class="form-control" required>
              <option value="">Seleziona un servizio</option>
              <option value="Consulenza Farmacista">Consulenza Farmacista</option>
              <option value="Ricetta Medica">Ricetta Medica</option>
              <option value="Controllo Pressione">Controllo Pressione</option>
              <option value="Vaccinazione">Vaccinazione</option>
              <option value="Altro">Altro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Nome Paziente *</label>
            <input type="text" id="apt-name" class="form-control" required placeholder="Es. Mario Rossi">
          </div>
          <div class="form-group">
            <label class="form-label">Telefono *</label>
            <input type="tel" id="apt-phone" class="form-control" required placeholder="Es. 333 1234567">
          </div>
          <div class="form-group">
            <label class="form-label">Note</label>
            <textarea id="apt-notes" class="form-control"
              placeholder="Eventuali note o richieste particolari..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-full">Prenota Appuntamento</button>
        </form>
        <div id="appointment-confirmation" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Medicine Info Tab -->
  <div id="medicine-tab" class="tab-content">
    <div class="card">
      <h2>Cerca Informazioni Farmaco</h2>
      <div class="search-tabs">
        <button class="search-tab active" onclick="switchSearchMode('name')">Cerca per Nome</button>
        <button class="search-tab" onclick="switchSearchMode('photo')">Cerca con Foto</button>
      </div>

      <div id="search-by-name" class="search-section active">
        <div class="form-group">
          <label class="form-label">Nome Farmaco</label>
          <input type="text" id="medicine-search" class="form-control" placeholder="Es. Aspirina, Tachipirina...">
        </div>
        <button onclick="searchMedicine()" class="btn btn-primary btn-full">Cerca</button>
      </div>

      <div id="search-by-photo" class="search-section">
        <label class="file-upload" for="photo-upload">
          <div style="margin-bottom: 12px;"><i data-lucide="camera" style="width: 48px; height: 48px;"></i></div>
          <div style="font-weight: 500; margin-bottom: 8px;">Carica foto del farmaco</div>
          <div style="font-size: 12px; color: var(--color-text-secondary);">Clicca per selezionare un'immagine</div>
          <input type="file" id="photo-upload" accept="image/*">
        </label>
      </div>

      <div id="medicine-result"></div>
    </div>
  </div>

  <!-- AI Consultant Tab -->
  <div id="ai-tab" class="tab-content">
    <div class="card">
      <h2>Consulente AI</h2>
      <p style="color: var(--color-text-secondary); margin-bottom: 16px;">Fai domande sulla salute e sui farmaci. L'AI
        ti fornirГ  informazioni utili.</p>

      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message message-ai">
            Ciao! Sono il tuo assistente farmaceutico virtuale. Come posso aiutarti oggi?
          </div>
        </div>
        <div class="chat-input-container">
          <input type="text" id="chat-input" class="form-control chat-input" placeholder="Scrivi la tua domanda...">
          <button onclick="sendMessage()" class="btn btn-primary">Invia</button>
        </div>
      </div>
      <button onclick="clearChat()" class="btn btn-secondary" style="margin-top: 12px;">Cancella Cronologia</button>
    </div>
  </div>

  <!-- Account Tab -->
  <div id="account-tab" class="tab-content">
    <div class="card">
      <h2>Mio Account</h2>
      <div id="account-alert" class="alert" style="display: none;"></div>

      <div class="form-group">
        <h3>Informazioni Personali</h3>
      </div>

      <form id="profile-form" onsubmit="handleProfileUpdate(event)">
        <div class="form-group">
          <label class="form-label">Nome Completo</label>
          <input type="text" id="profile-name" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="profile-email" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Telefono</label>
          <input type="tel" id="profile-phone" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary btn-full">Salva Modifiche</button>
      </form>
    </div>

    <div class="card">
      <h3>Cambia Password</h3>
      <form id="password-form" onsubmit="handlePasswordChange(event)">
        <div class="form-group">
          <label class="form-label">Password Attuale</label>
          <input type="password" id="current-password" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Nuova Password</label>
          <input type="password" id="new-password" class="form-control" required minlength="6">
        </div>
        <div class="form-group">
          <label class="form-label">Conferma Nuova Password</label>
          <input type="password" id="confirm-password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary btn-full">Cambia Password</button>
      </form>
    </div>

    <div class="card">
      <button onclick="handleLogout()" class="btn btn-danger btn-full">Esci dall'Account</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="home" onclick="switchTab('home')">
      <div class="nav-icon"><i data-lucide="home"></i></div>
      <div>Home</div>
    </button>
    <button class="nav-item" data-tab="appointments" onclick="switchTab('appointments')">
      <div class="nav-icon"><i data-lucide="calendar"></i></div>
      <div>Appuntamenti</div>
    </button>
    <button class="nav-item" data-tab="medicine" onclick="switchTab('medicine')">
      <div class="nav-icon"><i data-lucide="pill"></i></div>
      <div>Farmaci</div>
    </button>
    <button class="nav-item" data-tab="ai" onclick="switchTab('ai')">
      <div class="nav-icon"><i data-lucide="bot"></i></div>
      <div>Consulente AI</div>
    </button>

  </nav>

  <script>
    // Require authentication
    requireAuth();

    // Initialize Lucide Icons
    lucide.createIcons();

    // Display user greeting
    function updateUserGreeting() {
      const user = getCurrentUser();
      if (user) {
        document.getElementById('user-greeting').textContent = `Ciao, ${user.name.split(' ')[0]}!`;
      }
    }

    // Load user profile data
    function loadUserProfile() {
      const user = getCurrentUser();
      if (user) {
        document.getElementById('profile-name').value = user.name;
        document.getElementById('profile-email').value = user.email;
        document.getElementById('profile-phone').value = user.phone;
      }
    }

    // Handle profile update
    function handleProfileUpdate(event) {
      event.preventDefault();
      const name = document.getElementById('profile-name').value;
      const email = document.getElementById('profile-email').value;
      const phone = document.getElementById('profile-phone').value;

      const result = updateProfile(name, email, phone);
      showAccountAlert(result.message, result.success ? 'success' : 'error');

      if (result.success) {
        updateUserGreeting();
      }
    }

    // Handle password change
    function handlePasswordChange(event) {
      event.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        showAccountAlert('Le nuove password non corrispondono', 'error');
        return;
      }

      const result = changePassword(currentPassword, newPassword);
      showAccountAlert(result.message, result.success ? 'success' : 'error');

      if (result.success) {
        document.getElementById('password-form').reset();
      }
    }

    // Show alert in account section
    function showAccountAlert(message, type) {
      const alert = document.getElementById('account-alert');
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.style.display = 'block';

      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }

    // Handle logout
    function handleLogout() {
      if (confirm('Sei sicuro di voler uscire?')) {
        logout();
      }
    }
    // Medicine Database
    const medicines = [
      {
        name: 'Aspirina',
        ingredient: 'Acido acetilsalicilico',
        uses: 'Dolore, febbre, infiammazione',
        dosage: '500-1000 mg',
        frequency: 'Ogni 4-6 ore, massimo 3000 mg al giorno',
        instructions: 'Con acqua dopo i pasti',
        sideeffects: 'Mal di stomaco, bruciore, reazioni allergiche',
        contraindications: 'Ulcera gastrica, allergia all\'aspirina',
        storage: 'A temperatura ambiente, al riparo dall\'umiditГ '
      },
      {
        name: 'Tachipirina',
        ingredient: 'Paracetamolo',
        uses: 'Febbre, dolore, emicrania',
        dosage: '500-1000 mg',
        frequency: 'Ogni 4-6 ore, massimo 3000 mg al giorno',
        instructions: 'Con o senza cibo, meglio con acqua',
        sideeffects: 'Raro, possibile allergia',
        contraindications: 'Insufficienza epatica',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Ibuprofene',
        ingredient: 'Ibuprofene',
        uses: 'Dolore, febbre, infiammazione, artrite',
        dosage: '200-400 mg',
        frequency: 'Ogni 4-6 ore, massimo 1200 mg al giorno',
        instructions: 'Con cibo o latte per evitare disturbi allo stomaco',
        sideeffects: 'Nausea, aciditГ , dolori addominali',
        contraindications: 'Ulcera, allergia FANS, problemi renali',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Amoxicillina',
        ingredient: 'Amoxicillina triidrato',
        uses: 'Infezioni batteriche, faringite, bronchite',
        dosage: '250-500 mg',
        frequency: 'Ogni 8 ore per 7-10 giorni',
        instructions: 'Con o senza cibo, completare la cura',
        sideeffects: 'Reazioni allergiche, diarrea, nausea',
        contraindications: 'Allergia alla penicillina',
        storage: 'In frigorifero o a temperatura ambiente secondo prescrizione'
      },
      {
        name: 'Augmentin',
        ingredient: 'Amoxicillina + Acido clavulanico',
        uses: 'Infezioni batteriche resistenti',
        dosage: '875/125 mg',
        frequency: 'Ogni 12 ore per 7-10 giorni',
        instructions: 'Con cibo per ridurre nausea',
        sideeffects: 'Diarrea, nausea, rash',
        contraindications: 'Allergia beta-lattamici',
        storage: 'In frigorifero se sospensione'
      },
      {
        name: 'Cardioaspirina',
        ingredient: 'Acido acetilsalicilico',
        uses: 'Prevenzione cardiovascolare, infarto',
        dosage: '100 mg',
        frequency: 'Una volta al giorno',
        instructions: 'Dopo colazione, non masticare',
        sideeffects: 'Possibile sanguinamento, mal di stomaco',
        contraindications: 'Allergia, ulcera gastrica, sanguinamenti',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Omeprazolo',
        ingredient: 'Omeprazolo',
        uses: 'AciditГ , reflusso gastroesofageo, ulcera',
        dosage: '20-40 mg',
        frequency: 'Una volta al giorno, prima dei pasti',
        instructions: 'Ingoiare intero, non masticare',
        sideeffects: 'Mal di testa, diarrea, vertigini',
        contraindications: 'Allergia, carenza di vitamina B12',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Metformina',
        ingredient: 'Metformina cloridrato',
        uses: 'Diabete tipo 2, controllo glicemico',
        dosage: '500-1000 mg',
        frequency: '2-3 volte al giorno con i pasti',
        instructions: 'Con i pasti per ridurre nausea',
        sideeffects: 'Nausea, diarrea, sapore metallico',
        contraindications: 'Insufficienza renale, insufficienza epatica',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Ramipril',
        ingredient: 'Ramipril',
        uses: 'Pressione alta, prevenzione cardiaca',
        dosage: '2.5-5 mg',
        frequency: 'Una volta al giorno',
        instructions: 'Con o senza cibo',
        sideeffects: 'Tosse secca, vertigini, affaticamento',
        contraindications: 'Gravidanza, angioedema precedente',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Atorvastatina',
        ingredient: 'Atorvastatina calcica',
        uses: 'Colesterolo alto, prevenzione cardiovascolare',
        dosage: '10-80 mg',
        frequency: 'Una volta al giorno, preferibilmente sera',
        instructions: 'Con o senza cibo',
        sideeffects: 'Dolori muscolari, mal di testa, nausea',
        contraindications: 'Malattia epatica attiva, gravidanza',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Loratadina',
        ingredient: 'Loratadina',
        uses: 'Allergie, orticaria, pruriti',
        dosage: '10 mg',
        frequency: 'Una volta al giorno',
        instructions: 'Con o senza cibo',
        sideeffects: 'Sonnolenza leggera, mal di testa',
        contraindications: 'Allergia, insufficienza epatica grave',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Cetirizina',
        ingredient: 'Cetirizina diidrocloruro',
        uses: 'Allergie stagionali, rinite',
        dosage: '10 mg',
        frequency: 'Una volta al giorno',
        instructions: 'Con o senza cibo',
        sideeffects: 'Sonnolenza, bocca secca, mal di testa',
        contraindications: 'Allergia, insufficienza renale grave',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Bisoprololo',
        ingredient: 'Bisoprololo fumarato',
        uses: 'Pressione alta, angina, insufficienza cardiaca',
        dosage: '1.25-10 mg',
        frequency: 'Una volta al giorno',
        instructions: 'Con o senza cibo, preferibilmente mattina',
        sideeffects: 'Affaticamento, vertigini, depressione',
        contraindications: 'Bradicardia, insufficienza cardiaca scompensata',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Levotiroxina',
        ingredient: 'Levotiroxina sodica',
        uses: 'Ipotiroidismo, insufficienza tiroidea',
        dosage: '50-200 mcg',
        frequency: 'Una volta al giorno al mattino',
        instructions: '30 min prima colazione, con acqua',
        sideeffects: 'Palpitazioni, ansia, insonnia se dosaggio alto',
        contraindications: 'Ipertiroidismo, cardiopatia ischemica',
        storage: 'A temperatura ambiente'
      },
      {
        name: 'Vitamina D3',
        ingredient: 'Colecalciferolo',
        uses: 'Carenza vitamina D, ossa, immunitГ ',
        dosage: '1000-4000 IU',
        frequency: 'Una volta al giorno con cibo',
        instructions: 'Con pasto contenente grassi',
        sideeffects: 'Raro, ipercalcemia se dosaggio eccessivo',
        contraindications: 'Ipercalcemia, sarcoidosi',
        storage: 'A temperatura ambiente'
      }
    ];

    // Appointments storage (in-memory)
    let appointments = [];
    let appointmentCounter = 1;

    // Chat history (in-memory)
    let chatHistory = [];

    // AI Booking State
    let bookingState = {
      active: false,
      step: null, // 'date', 'time', 'service', 'name', 'confirm'
      data: {}
    };

    // Initialize date picker with min/max dates
    function initializeDatePicker() {
      const dateInput = document.getElementById('apt-date');
      const today = new Date();
      const maxDate = new Date();
      maxDate.setDate(today.getDate() + 30);

      dateInput.min = today.toISOString().split('T')[0];
      dateInput.max = maxDate.toISOString().split('T')[0];
    }

    // Tab Navigation
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      document.getElementById(`${tabName}-tab`).classList.add('active');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      if (tabName === 'medicine') {
        document.getElementById('medicine-result').innerHTML = '';
      }
      if (tabName === 'account') {
        loadUserProfile(); // Load user data when account tab is opened
      }
    }

    // Search Mode Toggle
    function switchSearchMode(mode) {
      document.querySelectorAll('.search-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.search-section').forEach(section => {
        section.classList.remove('active');
      });

      if (mode === 'name') {
        document.querySelector('.search-tab:first-child').classList.add('active');
        document.getElementById('search-by-name').classList.add('active');
      } else {
        document.querySelector('.search-tab:last-child').classList.add('active');
        document.getElementById('search-by-photo').classList.add('active');
      }
    }

    // Appointment Form Submit
    document.getElementById('appointment-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const appointmentData = {
        date: document.getElementById('apt-date').value,
        time: document.getElementById('apt-time').value,
        service: document.getElementById('apt-service').value,
        name: document.getElementById('apt-name').value,
        phone: document.getElementById('apt-phone').value,
        notes: document.getElementById('apt-notes').value
      };

      // Save appointment using auth.js function
      const result = saveAppointment(appointmentData);

      if (result.success) {
        // Show confirmation
        const confirmationDiv = document.getElementById('appointment-confirmation');
        confirmationDiv.innerHTML = `
          <div class="alert alert-success">
            <strong><i data-lucide="check-circle" class="icon-sm"></i> Appuntamento confermato!</strong><br>
            Data: ${formatDate(result.appointment.date)} alle ${result.appointment.time}<br>
            Servizio: ${result.appointment.service}
          </div>
        `;
        lucide.createIcons({ root: confirmationDiv });
        confirmationDiv.style.display = 'block';

        // Update appointments list
        updateAppointmentsList();

        // Hide confirmation after 2 seconds
        setTimeout(() => {
          confirmationDiv.style.display = 'none';
          hideBookingForm();
        }, 2000);
      }

      this.reset();
    });

    // Create Appointment (Shared Function)
    function createAppointment(data) {
      const appointment = {
        id: appointmentCounter++,
        ...data
      };

      appointments.push(appointment);

      // Show confirmation
      const confirmationDiv = document.getElementById('appointment-confirmation');
      confirmationDiv.innerHTML = `
        <div class="alert alert-success">
          <strong><i data-lucide="check-circle" class="icon-sm"></i> Appuntamento confermato!</strong><br>
          ID Appuntamento: #${appointment.id}<br>
          Data: ${formatDate(appointment.date)} alle ${appointment.time}<br>
          Servizio: ${appointment.service}
        </div>
      `;
      lucide.createIcons({ root: confirmationDiv });
      confirmationDiv.style.display = 'block';

      // Update appointments list
      updateAppointmentsList();

      // Hide confirmation after 5 seconds
      setTimeout(() => {
        confirmationDiv.style.display = 'none';
        hideBookingForm(); // Return to list view
      }, 2000);

      return appointment;
    }

    // View Toggling Logic
    function showBookingForm() {
      document.getElementById('appointments-view').classList.add('hidden');
      document.getElementById('booking-view').classList.remove('hidden');
      lucide.createIcons(); // Refresh icons if needed
    }

    function hideBookingForm() {
      document.getElementById('booking-view').classList.add('hidden');
      document.getElementById('appointments-view').classList.remove('hidden');
    }

    // Update Appointments List
    function updateAppointmentsList() {
      const listDiv = document.getElementById('appointments-list');

      // Get user's appointments from auth.js
      appointments = getUserAppointments();

      if (appointments.length === 0) {
        listDiv.innerHTML = '<div class="alert alert-info">Nessun appuntamento prenotato.</div>';
        return;
      }

      listDiv.innerHTML = appointments.map(apt => `
        <div class="appointment-item">
          <h4>Appuntamento #${apt.id}</h4>
          <p><strong><i data-lucide="calendar" class="icon-sm"></i> Data:</strong> ${formatDate(apt.date)}</p>
          <p><strong><i data-lucide="clock" class="icon-sm"></i> Orario:</strong> ${apt.time}</p>
          <p><strong><i data-lucide="activity" class="icon-sm"></i> Servizio:</strong> ${apt.service}</p>
          <p><strong><i data-lucide="user" class="icon-sm"></i> Paziente:</strong> ${apt.name}</p>
          <p><strong><i data-lucide="phone" class="icon-sm"></i> Telefono:</strong> ${apt.phone}</p>
          ${apt.notes ? `<p><strong><i data-lucide="file-text" class="icon-sm"></i> Note:</strong> ${apt.notes}</p>` : ''}
          <div class="appointment-actions">
            <button class="btn btn-danger" onclick="cancelAppointment(${apt.id})">Cancella</button>
          </div>
        </div>
      `).join('');
      lucide.createIcons({ root: listDiv });
    }

    // Cancel Appointment
    function cancelAppointment(id) {
      if (confirm('Sei sicuro di voler cancellare questo appuntamento?')) {
        deleteAppointment(id);
        updateAppointmentsList();
      }
    }

    // Format Date
    function formatDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      return date.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Search Medicine by Name
    function searchMedicine() {
      const searchTerm = document.getElementById('medicine-search').value.trim().toLowerCase();

      if (!searchTerm) {
        alert('Inserisci il nome di un farmaco');
        return;
      }

      const medicine = medicines.find(m => m.name.toLowerCase() === searchTerm);

      if (medicine) {
        displayMedicineInfo(medicine);
      } else {
        document.getElementById('medicine-result').innerHTML = `
          <div class="alert alert-info">
            Farmaco non trovato. Prova con un altro nome o consulta il farmacista.
          </div>
        `;
      }
    }

    // Quick search from home
    function searchMedicineByName(name) {
      switchTab('medicine');
      document.getElementById('medicine-search').value = name;
      setTimeout(() => searchMedicine(), 100);
    }

    // Photo Upload Handler
    document.getElementById('photo-upload').addEventListener('change', function (e) {
      if (e.target.files.length > 0) {
        // Simulate photo recognition
        setTimeout(() => {
          const randomMedicine = medicines[Math.floor(Math.random() * medicines.length)];
          const confidence = Math.floor(Math.random() * 15) + 85; // 85-99%

          displayMedicineInfo(randomMedicine, confidence);
        }, 1000);
      }
    });

    // Display Medicine Info
    function displayMedicineInfo(medicine, confidence = null) {
      const resultDiv = document.getElementById('medicine-result');

      let html = '<div class="medicine-result">';

      if (confidence) {
        html += `<div class="confidence-badge"><i data-lucide="check" class="icon-sm"></i> Riconoscimento: ${confidence}%</div>`;
      }

      html += `
        <h3>${medicine.name}</h3>
        <div class="medicine-info-item">
          <strong><i data-lucide="flask-conical" class="icon-sm"></i> Principio Attivo</strong>
          <p>${medicine.ingredient}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="pill" class="icon-sm"></i> Indicazioni d'Uso</strong>
          <p>${medicine.uses}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="bar-chart-2" class="icon-sm"></i> Dosaggio</strong>
          <p>${medicine.dosage}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="clock" class="icon-sm"></i> Frequenza</strong>
          <p>${medicine.frequency}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="clipboard-list" class="icon-sm"></i> Come Assumere</strong>
          <p>${medicine.instructions}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="alert-triangle" class="icon-sm"></i> Effetti Collaterali</strong>
          <p>${medicine.sideeffects}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="ban" class="icon-sm"></i> Controindicazioni</strong>
          <p>${medicine.contraindications}</p>
        </div>
        <div class="medicine-info-item">
          <strong><i data-lucide="home" class="icon-sm"></i> Conservazione</strong>
          <p>${medicine.storage}</p>
        </div>
      </div>`;

      resultDiv.innerHTML = html;
      lucide.createIcons({ root: resultDiv });
    }

    // AI Chat Functions
    function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();

      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      chatHistory.push({ role: 'user', content: message });

      // Clear input
      input.value = '';

      // Generate AI response
      setTimeout(() => {
        const response = generateAIResponse(message);
        addMessage(response, 'ai');
        chatHistory.push({ role: 'ai', content: response });
      }, 500);
    }

    // Add message to chat
    function addMessage(text, sender) {
      const messagesDiv = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${sender}`;
      messageDiv.textContent = text;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Generate AI Response
    function generateAIResponse(message) {
      const lowerMessage = message.toLowerCase();

      // 1. Check if we are in a booking flow
      if (bookingState.active) {
        return handleBookingStep(message);
      }

      // 2. Check for booking intent
      if (lowerMessage.includes('prenota') || (lowerMessage.includes('appuntamento') && !lowerMessage.includes('dove') && !lowerMessage.includes('quando'))) {
        startBooking();
        return 'Certamente! Posso aiutarti a prenotare un appuntamento. Per quale data vorresti prenotare? (es. domani, 2023-12-25)';
      }

      // 3. Normal AI Logic
      // Check for medicine names
      for (const med of medicines) {
        if (lowerMessage.includes(med.name.toLowerCase())) {
          return `${med.name} ГЁ un farmaco contenente ${med.ingredient}. Г€ utilizzato per: ${med.uses}. Il dosaggio tipico ГЁ ${med.dosage}, ${med.frequency}. Si assume ${med.instructions}. Per informazioni dettagliate, consulta la sezione Farmaci o parla con il farmacista.`;
        }
      }

      // Health topics
      if (lowerMessage.includes('febbre')) {
        return 'Per la febbre, ГЁ consigliabile assumere antipiretici come Tachipirina (paracetamolo) o Aspirina. Bevi molti liquidi e riposa. Se la febbre supera i 39В°C o persiste per piГ№ di 3 giorni, consulta un medico.';
      }

      if (lowerMessage.includes('mal di testa') || lowerMessage.includes('emicrania')) {
        return 'Per il mal di testa, puoi assumere Tachipirina, Aspirina o Ibuprofene. Riposa in un ambiente tranquillo e buio. Se il mal di testa ГЁ frequente o molto intenso, consulta un medico.';
      }

      if (lowerMessage.includes('dolore') || lowerMessage.includes('male')) {
        return 'Per il dolore lieve-moderato, sono efficaci Tachipirina, Aspirina o Ibuprofene. Segui le indicazioni sul dosaggio. Se il dolore persiste o peggiora, consulta un medico o un farmacista.';
      }

      if (lowerMessage.includes('stomaco') || lowerMessage.includes('aciditГ ') || lowerMessage.includes('bruciore')) {
        return 'Per problemi di aciditГ  o bruciore di stomaco, l\'Omeprazolo puГІ aiutare. Evita cibi grassi, piccanti e alcol. Mangia porzioni piГ№ piccole e non coricarti subito dopo i pasti. Se i sintomi persistono, consulta un medico.';
      }

      if (lowerMessage.includes('allergia') || lowerMessage.includes('prurito')) {
        return 'Per allergie e pruriti, antistaminici come Loratadina o Cetirizina possono aiutare. Evita gli allergeni noti. Se hai reazioni gravi come difficoltГ  respiratorie, chiama immediatamente il 118.';
      }

      if (lowerMessage.includes('pressione') || lowerMessage.includes('ipertensione')) {
        return 'La pressione alta richiede monitoraggio regolare e spesso farmaci come Ramipril o Bisoprololo. Mantieni uno stile di vita sano: riduci il sale, fai attivitГ  fisica, evita lo stress. Consulta sempre il medico per la terapia adeguata.';
      }

      if (lowerMessage.includes('colesterolo')) {
        return 'Per il colesterolo alto, farmaci come Atorvastatina possono essere prescritti. Importante anche la dieta: riduci grassi saturi, aumenta fibre e omega-3. Fai attivitГ  fisica regolare. Consulta il medico per un piano personalizzato.';
      }

      if (lowerMessage.includes('diabete') || lowerMessage.includes('glicemia')) {
        return 'Il diabete tipo 2 puГІ essere gestito con farmaci come Metformina, dieta equilibrata e attivitГ  fisica. Controlla regolarmente la glicemia. Г€ fondamentale il supporto di un medico e un dietologo.';
      }

      if (lowerMessage.includes('vitamina')) {
        return 'Le vitamine sono importanti per la salute. La Vitamina D3 ГЁ essenziale per ossa e sistema immunitario. Una dieta varia fornisce la maggior parte delle vitamine necessarie. Per integratori specifici, consulta il farmacista o il medico.';
      }

      if (lowerMessage.includes('orari') || lowerMessage.includes('aperto')) {
        return 'La Farmacia Centrale ГЁ aperta: Lun-Ven 08:30-20:00, Sabato 08:30-19:00, Domenica 09:00-13:00. Siamo in Via Roma, 123 a Vercelli. Tel: +39 0161 234567.';
      }

      // Default responses
      const defaultResponses = [
        'Grazie per la tua domanda. Per consigli personalizzati sui farmaci, ti consiglio di consultare direttamente il farmacista. Posso aiutarti con informazioni generali sui farmaci nel nostro database.',
        'Г€ importante consultare un professionista sanitario per diagnosi e trattamenti specifici. Posso fornirti informazioni generali sui farmaci. Cerca un farmaco specifico nella sezione "Farmaci" per maggiori dettagli.',
        'Per una consulenza personalizzata, ti invito a prenotare un appuntamento con il nostro farmacista. Nel frattempo, posso aiutarti con informazioni generali sulla salute e sui farmaci.',
        'La tua salute ГЁ importante! Per questioni specifiche, consulta sempre un medico o farmacista. Posso fornirti informazioni generali sui farmaci e consigli di benessere.'
      ];

      return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
    }

    // Start Booking Flow
    function startBooking() {
      bookingState = {
        active: true,
        step: 'date',
        data: {}
      };
    }

    // Handle Booking Steps
    function handleBookingStep(message) {
      const lowerMessage = message.toLowerCase();

      // Cancel flow
      if (lowerMessage.includes('annulla') || lowerMessage.includes('stop') || lowerMessage.includes('basta')) {
        bookingState.active = false;
        return 'Prenotazione annullata. Posso aiutarti con altro?';
      }

      switch (bookingState.step) {
        case 'date':
          // Simple date parsing logic
          let date = message;
          if (lowerMessage.includes('domani')) {
            const d = new Date();
            d.setDate(d.getDate() + 1);
            date = d.toISOString().split('T')[0];
          } else if (lowerMessage.includes('oggi')) {
            date = new Date().toISOString().split('T')[0];
          }
          // Basic validation (very loose)
          bookingState.data.date = date;
          bookingState.step = 'time';
          return `Perfetto, per il ${date}. A che ora preferisci? (es. 09:00, 15:30)`;

        case 'time':
          bookingState.data.time = message;
          bookingState.step = 'service';
          return 'Ottimo. Che tipo di servizio ti serve? (es. Consulenza, Ricetta, Vaccinazione)';

        case 'service':
          bookingState.data.service = message;
          bookingState.step = 'name';
          return 'D\'accordo. A che nome devo prenotare?';

        case 'name':
          bookingState.data.name = message;
          bookingState.step = 'confirm';
          return `Riepilogo prenotazione:
          рџ“… Data: ${bookingState.data.date}
          рџ•ђ Ora: ${bookingState.data.time}
          рџЏҐ Servizio: ${bookingState.data.service}
          рџ‘¤ Nome: ${bookingState.data.name}
          
          Confermi la prenotazione? (SГ¬/No)`;

        case 'confirm':
          if (lowerMessage.includes('sГ¬') || lowerMessage.includes('si') || lowerMessage.includes('ok') || lowerMessage.includes('certo')) {
            saveAppointment({
              date: bookingState.data.date, // Note: In a real app, validate format YYYY-MM-DD
              time: bookingState.data.time,
              service: bookingState.data.service,
              name: bookingState.data.name,
              phone: 'Da Chat AI',
              notes: 'Prenotato via AI'
            });
            bookingState.active = false;
            return 'вњ… Prenotazione confermata con successo! La trovi nella sezione "Appuntamenti".';
          } else {
            bookingState.active = false;
            return 'Prenotazione annullata. Se vuoi riprovare, dimmelo pure.';
          }
      }
    }

    // Clear Chat
    function clearChat() {
      if (confirm('Vuoi cancellare tutta la cronologia della chat?')) {
        chatHistory = [];
        document.getElementById('chat-messages').innerHTML = `
          <div class="message message-ai">
            Ciao! Sono il tuo assistente farmaceutico virtuale. Come posso aiutarti oggi?
          </div>
        `;
      }
    }

    // Chat input Enter key
    document.getElementById('chat-input').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', function () {
      initializeDatePicker();
      updateAppointmentsList();
      updateUserGreeting();
      loadUserProfile();
    });
  </script>
</body>

</html>